{% extends "base.html" %}

{% block title %}ì¬ê³  ê´€ë¦¬{% endblock %}

{% block content %}
<style>
    h1, h2 {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--text-color);
        margin-bottom: 24px;
        text-align: center;
    }

    .tab-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 24px;
    }

    .tab {
        padding: 8px 16px;
        border-radius: 6px;
        background-color: #dcdde1;
        color: #2f3542;
        text-decoration: none;
        font-size: 0.95rem;
        font-weight: 500;
        transition: background-color 0.2s ease;
    }

    .tab:hover {
        background-color: #a4b0be;
        color: white;
    }

    .tab.active {
        background-color: #b0b3b8; 
        color: #2f3542;
    }

    form {
        max-width: 520px;
        margin: 0 auto 30px;
        background-color: var(--card-bg);
        padding: 24px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        font-size: 0.95rem;
    }
    .form-row {
        margin-bottom: 16px;
    }
    .form-row label {
        font-weight: 600;
        display: block;
        margin-bottom: 6px;
    }
    label {
        font-weight: 600;
        margin-bottom: 6px;
        display: block;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 0.95rem;
        background-color: #fff;
        margin-bottom: 16px;
    }

    button {
        padding: 10px 16px;
        font-size: 0.95rem;
        font-weight: bold;
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    button:hover {
        background-color: var(--primary-hover);
    }

    .success-message,
    .error-message {
        max-width: 520px;
        margin: 0 auto 30px;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 0.95rem;
    }

    .success-message {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .error-message {
        background-color: #fdecea;
        color: #c0392b;
        border: 1px solid #e74c3c;
    }

    #productModal,
    #modalOverlay {
        display: none;
        position: fixed;
        z-index: 1000;
    }

    #modalOverlay {
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 999;
    }

    #productModal {
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 420px;
        background: white;
        padding: 24px 30px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    #productModal h3 {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 16px;
        color: var(--text-color);
        text-align: center;
    }

    #productList {
        max-height: 220px;
        overflow-y: auto;
        margin-bottom: 16px;
    }

    #productList label {
        display: block;
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    #productList label:hover {
        background-color: #f1f2f6;
    }

    .modal-button {
        width: 100%;
        padding: 10px;
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        font-size: 0.95rem;
        cursor: pointer;
    }

    .modal-button:hover {
        background-color: var(--primary-hover);
    }
</style>


<h1>ì¬ê³  í†µí•© ê´€ë¦¬</h1>

<!-- íƒ­ ë©”ë‰´ -->
<div class="tab-container">
    <a class="tab {{ 'active' if action == 'in' else '' }}" href="{{ url_for('manage_inventory', action='in') }}">ì…ê³  (In)</a>
    <a class="tab {{ 'active' if action == 'out' else '' }}" href="{{ url_for('manage_inventory', action='out') }}">ì¶œê³  (Out)</a>
    <a class="tab {{ 'active' if action == 'transfer' else '' }}" href="{{ url_for('manage_inventory', action='transfer') }}">ì°½ê³ ì´ë™ (Transfer)</a>
</div>

<!-- ë©”ì‹œì§€ í‘œì‹œ -->
{% if message %}
    {% if "âœ…" in message %}
        <div class="success-message">{{ message|safe }}</div>
    {% else %}
        <div class="error-message">{{ message|safe }}</div>
    {% endif %}
{% endif %}

<!-- ì œí’ˆ ì„ íƒ ëª¨ë‹¬ -->
<div id="productModal" style="display:none; position:fixed; top:20%; left:30%; width:40%; background:white; border:1px solid #ccc; padding:20px; z-index:1000;">
    <h3>Choose which product</h3>
    <div id="productList"></div>
    <button onclick="closeModal()">Close</button>
</div>
<div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;" onclick="closeModal()"></div>

<!-- ê° ì•¡ì…˜ë³„ í¼ -->
{% if action == 'in' %}
    <h2>ğŸ“¦ ì…ê³  (In)</h2>
    {% if not product %}
        <form method="post">
            <input type="hidden" name="action" value="{{ action }}">
            ì œí’ˆ ì‹ë³„ì (SKU or Barcode): <input name="identifier" required value="{{ identifier or '' }}">
            <button type="button" onclick="fetchProductsByBarcode()">ì œí’ˆ ì°¾ê¸°</button>
        </form>
    {% else %}
        <form method="post">
            <input type="hidden" name="action" value="in">
            <input type="hidden" name="identifier" value="{{ identifier }}">

            <p><b>SKU:</b> {{ identifier }}</p>
            <p><b>ì œí’ˆëª…:</b> {{ product.name }}</p>
            <p><b>ì˜ë¬¸ëª…:</b> {{ product.english_name }}</p>

            <label>ë°•ìŠ¤ ìˆ˜ëŸ‰ (Box Qty)</label>
            <input name="box_qty" type="number">

            <label>ë‚±ê°œ ìˆ˜ëŸ‰ (Piece Qty)</label>
            <input name="piece_qty" type="number">

            <label>ì…ìˆ˜ëŸ‰ (Unit)</label>
            <input name="unit_per_box" type="number">

            <label>ì°½ê³ ëª… (Warehouse)</label>
            <select name="warehouse">
                <option value="ì‹ ì°½ê³  A">ì‹ ì°½ê³  (A)</option>
                <option value="ë§¤ì¥ì°½ê³  B">ë§¤ì¥ì°½ê³  (B)</option>
                <option value="ê¸°íƒ€ C">ê¸°íƒ€ (C)</option>
            </select>

            <label>ì„ ë°˜ ìœ„ì¹˜ (Shelf)</label>
            <input name="shelf_location" type="text">

            <label>ë°œì£¼ë²ˆí˜¸ (Order No.)</label>
            <input name="order_number" type="text">

            <label>ìœ í†µê¸°í•œ (Expiry)</label>
            <input type="date" name="expiration_date">

            <button type="submit">Confirm</button>
        </form>


    {% endif %}
{% elif action == 'out' %}
    <h2>ğŸ“¤ ì¶œê³  (Out)</h2>
    {% if not product %}
        <form method="post">
            <input type="hidden" name="action" value="{{ action }}">
            ì œí’ˆ ì‹ë³„ì (SKU or Barcode): <input name="identifier" required value="{{ identifier or '' }}">
            <button type="button" onclick="fetchProductsByBarcode()">ì œí’ˆ ì°¾ê¸°</button>
        </form>
    {% else %}
        <form method="post" onsubmit="return checkExpiryBeforeSubmit(this)">
            <input type="hidden" name="action" value="{{ action }}">
            <input type="hidden" name="identifier" value="{{ identifier }}">
            <p><b>SKU:</b> {{ identifier }}</p>
            <p><b>ì œí’ˆëª…:</b> {{ product.name }}</p>
            <p><b>ì˜ë¬¸ëª…:</b> {{ product.english_name }}</p>
            ì¶œê³  ìœ í˜• (Type):
            <select name="movement_type">
                <option value="ì¶œê³ ">ì¶œê³  (Out)</option>
                <option value="íê¸°">íê¸° (Discard)</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€ (Else)</option>
            </select>
            ì°½ê³ ëª… (Warehouse):
            <select name="warehouse">
                <option value="ì‹ ì°½ê³  A">ì‹ ì°½ê³  (A)</option>
                <option value="ë§¤ì¥ì°½ê³  B">ë§¤ì¥ì°½ê³  (B)</option>
                <option value="ê¸°íƒ€ C">ê¸°íƒ€ (C)</option>
            </select>
            ë°•ìŠ¤ ìˆ˜ëŸ‰ (Box Qty): <input name="box_qty" type="number">
            ë‚±ê°œ ìˆ˜ëŸ‰ (Piece Qty): <input name="piece_qty" type="number">
            ì…ìˆ˜ëŸ‰ (Unit): <input name="unit_per_box" type="number">
            ìœ í†µê¸°í•œ (Expiry): <input type="date" name="expiration_date">
            ì‚¬ìœ  (Reason): <input name="reason">
            <button type="submit">Confirm</button>
        </form>        
    {% endif %}
{% elif action == 'transfer' %}
    <h2>ğŸ” ì°½ê³ ì´ë™ (Transfer)</h2>
    {% if not product %}
        <form method="post">
            <input type="hidden" name="action" value="{{ action }}">
            ì œí’ˆ ì‹ë³„ì (SKU or Barcode): <input name="identifier" required value="{{ identifier or '' }}">
            <button type="button" onclick="fetchProductsByBarcode()">ì œí’ˆ ì°¾ê¸°</button>
        </form>
    {% else %}
        <form method="post">
            <input type="hidden" name="action" value="{{ action }}">
            <input type="hidden" name="identifier" value="{{ identifier }}">
            <p><b>SKU:</b> {{ identifier }}</p>
            <p><b>ì œí’ˆëª…:</b> {{ product.name }}</p>
            <p><b>ì˜ë¬¸ëª…:</b> {{ product.english_name }}</p>
            ë°•ìŠ¤ ìˆ˜ëŸ‰ (Box Qty): <input name="box_qty" type="number">
            ë‚±ê°œ ìˆ˜ëŸ‰ (Piece Qty): <input name="piece_qty" type="number">
            ì…ìˆ˜ëŸ‰ (Unit): <input name="unit_per_box" type="number">
            ì¶œë°œ ì°½ê³  (From):
            <select name="from_warehouse">
                <option value="ì‹ ì°½ê³  A">ì‹ ì°½ê³  (A)</option>
                <option value="ë§¤ì¥ì°½ê³  B">ë§¤ì¥ì°½ê³  (B)</option>
                <option value="ê¸°íƒ€ C">ê¸°íƒ€ (C)</option>
            </select>
            ë„ì°© ì°½ê³  (To):
            <select name="to_warehouse">
                <option value="ì‹ ì°½ê³  A">ì‹ ì°½ê³  (A)</option>
                <option value="ë§¤ì¥ì°½ê³  B">ë§¤ì¥ì°½ê³  (B)</option>
                <option value="ê¸°íƒ€ C">ê¸°íƒ€ (C)</option>
            </select>
            ìœ í†µê¸°í•œ (Expiry): <input type="date" name="expiration_date">
            <button type="submit">Confirm</button>
        </form>
    {% endif %}
{% endif %}

<!-- íŒì—… ë¡œì§ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
function fetchProductsByBarcode() {
    const barcode = document.querySelector('input[name="identifier"]').value;
    fetch(`/api/get_products_by_barcode?identifier=${barcode}`)
        .then(res => res.json())
        .then(data => {
            if (data.length === 0) {
                alert("í•´ë‹¹ ë°”ì½”ë“œë¡œ ë“±ë¡ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            } else if (data.length === 1) {
                document.querySelector('input[name="identifier"]').value = data[0].sku;
                document.querySelector('form').submit();
            } else {
                const list = document.getElementById("productList");
                list.innerHTML = "";
                data.forEach(p => {
                    const div = document.createElement("div");
                    div.innerHTML = `
                        <label>
                            <input type="radio" name="select_sku" value="${p.sku}"> ${p.name} (${p.english_name}) [${p.sku}]
                        </label>
                    `;
                    list.appendChild(div);
                });

                const confirmBtn = document.createElement("button");
                confirmBtn.innerText = "ì„ íƒ";
                confirmBtn.onclick = function () {
                    const selected = document.querySelector('input[name="select_sku"]:checked');
                    if (selected) {
                        document.querySelector('input[name="identifier"]').value = selected.value;
                        closeModal();
                        document.querySelector('form').submit();
                    }
                };
                list.appendChild(confirmBtn);

                openModal();
            }
        });
}

function openModal() {
    document.getElementById("productModal").style.display = "block";
    document.getElementById("modalOverlay").style.display = "block";
}
function closeModal() {
    document.getElementById("productModal").style.display = "none";
    document.getElementById("modalOverlay").style.display = "none";
}
</script>
<script>
function checkExpiryBeforeSubmit(form) {
    const actionInput = form.querySelector('input[name="action"]');
    if (!actionInput || actionInput.value !== 'out') return true;

    const expInput = form.querySelector('input[name="expiration_date"]');
    if (!expInput || !expInput.value) return true;  // ìœ í†µê¸°í•œ ì—†ìœ¼ë©´ ê²½ê³  ì—†ìŒ

    const expDate = new Date(expInput.value);
    const today = new Date();
    const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));

    if (diffDays < 0) {
        return confirm("âš ï¸ ìœ í†µê¸°í•œì´ ì´ë¯¸ ê²½ê³¼ëœ ì œí’ˆì…ë‹ˆë‹¤. ì¶œê³ ë¥¼ ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
    } else if (diffDays <= 30) {
        return confirm(`âš ï¸ ìœ í†µê¸°í•œì´ ${diffDays}ì¼ ë‚¨ì•˜ìŠµë‹ˆë‹¤. ì¶œê³ ë¥¼ ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
    }

    return true;  // ê²½ê³  ì¡°ê±´ì´ ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ ì§„í–‰
}
</script>


{% endblock %}