{% extends "base.html" %}

{% block title %}CS ë¡œê·¸ ë“±ë¡{% endblock %}

{% block content %}
<h2>ğŸ“ CS ë¡œê·¸ ë“±ë¡</h2>

{% if message %}
    <div class="flash-message">{{ message }}</div>
{% endif %}

<form method="post" action="{{ url_for('cslogs.register_cs_log') }}" class="form-container">
    <div class="form-group">
        <label for="identifier">ì œí’ˆ ì‹ë³„ì (SKU ë˜ëŠ” ì œí’ˆëª…)</label>
        <input type="text" id="identifier" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
        <button type="button" onclick="openProductSearch()">ì œí’ˆ ì°¾ê¸°</button>
    </div>

    <div id="selected-product" style="margin-top: 1em;">
        <p><b>SKU:</b> <span id="sku-text"></span></p>
        <p><b>ì œí’ˆëª…:</b> <span id="product-name-text"></span></p>
    </div>

    <input type="hidden" name="sku" id="sku">
    <input type="hidden" name="product_name" id="product_name">

    <div class="form-group">
        <label for="log_type">ìœ í˜•</label>
        <select id="log_type" name="log_type" required>
            <option value="">-- ì„ íƒ --</option>
            <option>íŒŒì†</option>
            <option>ì˜¤ë°œì†¡</option>
            <option>ì¬ë°œì†¡</option>
            <option>ë°œì†¡ëˆ„ë½</option>
            <option>ìœ í†µê¸°í•œ ê²½ê³¼</option>
            <option>ê¸°íƒ€</option>
        </select>
    </div>

    <div class="form-group">
        <label for="quantity">ìˆ˜ëŸ‰</label>
        <input type="number" id="quantity" name="quantity" required>
    </div>

    <div class="form-group">
        <label for="reason">ì‚¬ìœ </label>
        <textarea id="reason" name="reason" rows="3" required></textarea>
    </div>

    <div class="form-group">
        <label for="location">ìœ„ì¹˜</label>
        <select id="location" name="location" required>
            <option value="">-- ì„ íƒ --</option>
            <option>ì˜¨ë¼ì¸</option>
            <option>ë§¤ì¥</option>
        </select>
    </div>

    <div class="form-group">
        <button type="submit">ë“±ë¡</button>
    </div>
    <div id="product-modal" style="display:none; position:fixed; top:20%; left:30%; width:40%; background:white; border:1px solid #ccc; padding:1em; z-index:1000;">
        <h4>ğŸ” ì œí’ˆ ì„ íƒ</h4>
        <ul id="product-list"></ul>
        <button onclick="closeProductModal()">ë‹«ê¸°</button>
    </div>

</form>

<style>
    .form-container {
        max-width: 500px;
        margin-top: 10px;
    }

    .form-group {
        margin-bottom: 15px;
        position: relative;
    }

    label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
        width: 100%;
        padding: 8px;
        font-size: 0.95rem;
        border: 1px solid #ccc;
        border-radius: 6px;
    }

    textarea {
        resize: vertical;
    }

    button {
        padding: 10px 20px;
        background-color: #1e90ff;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
    }

    .flash-message {
        padding: 10px;
        background-color: #dff9fb;
        color: #0984e3;
        border: 1px solid #74b9ff;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-top: none;
        z-index: 10;
        max-height: 150px;
        overflow-y: auto;
    }

    .suggestions div {
        padding: 8px;
        cursor: pointer;
    }

    .suggestions div:hover {
        background-color: #f0f0f0;
    }
</style>
<script>
function openProductSearch() {
    const query = document.getElementById("identifier").value.trim();
    if (!query) {
        alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
    }

    fetch(`/api/product_search?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            const list = document.getElementById("product-list");
            list.innerHTML = "";
            if (data.length === 0) {
                list.innerHTML = "<li>ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</li>";
            } else {
                data.forEach(p => {
                    const li = document.createElement("li");
                    li.textContent = `${p.sku} - ${p.name}`;
                    li.style.cursor = "pointer";
                    li.onclick = () => selectProduct(p);
                    list.appendChild(li);
                });
            }
            document.getElementById("product-modal").style.display = "block";
        });
}

function selectProduct(product) {
    document.getElementById("sku-text").innerText = product.sku;
    document.getElementById("product-name-text").innerText = product.name;
    document.getElementById("sku").value = product.sku;
    document.getElementById("product_name").value = product.name;
    document.getElementById("product-modal").style.display = "none";
}

function closeProductModal() {
    document.getElementById("product-modal").style.display = "none";
}
</script>

{% endblock %}
